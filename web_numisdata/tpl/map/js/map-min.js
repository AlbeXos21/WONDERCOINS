"use strict";var map={form_container:null,rows_container:null,map_container:null,export_data_container:null,map_factory_instance:null,master_map_global_data:null,current_map_global_data:null,global_data:null,map_global_data:null,form:null,forn_node:null,map_config:null,button_state:!1,set_up:function(e){SHOW_DEBUG;const t=this;t.form_container=e.form_container,t.map_container=e.map_container,t.rows_container=e.rows_container,t.export_data_container=e.export_data_container;const n=page.render_export_data_buttons();t.export_data_container.appendChild(n),t.export_data_container.classList.add("hide"),t.source_maps=[{name:"OSM",url:"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{maxZoom:19}},{name:"Map Tiles",url:"https://api.maptiler.com/maps/basic/256/{z}/{x}/{y}@2x.png?key=udlBrEEE2SPm1In5dCNb",options:{maxZoom:20},default:!0},{name:"ARCGIS",url:"//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{}}];this.cargarTodoYCrearMapa({hallazgos:{datos:null},cecas:{datos:null},complejo:{datos:null}}),t.form=new form_factory;const a=t.render_form();t.form_container.appendChild(a),t.set_config();return document.getElementById("search_icon").addEventListener("mousedown",(function(){let e;!0===t.map_config.showing_search?(a.classList.add("hide"),e=!1):(a.classList.remove("hide"),e=!0),t.set_config({showing_search:e})})),!0===t.map_config.showing_search?a.classList.remove("hide"):a.classList.add("hide"),!0},cargarTodoYCrearMapa:async function(e){const t=this;try{const n=await data_manager.request({body:{dedalo_get:"records",table:"findspots",ar_fields:["*"],sql_filter:"",limit:0,count:!0,offset:0,order:"section_id ASC",process_result:null}});e.hallazgos.datos=n.result;const a=await data_manager.request({body:{dedalo_get:"records",table:"mints",ar_fields:["*"],sql_filter:"",limit:0,count:!0,offset:0,order:"name",process_result:null}});e.cecas.datos=a.result,t.map_factory_instance=new map_factory,t.map_factory_instance.init({map_container:t.map_container,map_position:[36.5297,-6.2924],source_maps:t.source_maps,result:e,map_node:this})}catch(e){}},set_config:function(e){const t=this,n=localStorage.getItem("map_config");if(n)t.map_config=JSON.parse(n);else{const e={showing_search:!1};localStorage.setItem("map_config",JSON.stringify(e)),t.map_config=e}if(e){for(const n in e)t.map_config[n]=e[n];localStorage.setItem("map_config",JSON.stringify(t.map_config))}return t.map_config},render_form:function(){const e=this,t=new DocumentFragment,n=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:t});common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:n}),e.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"name",value_wrapper:['["','"]'],sql_filter:" name LIKE '%%' AND name !='' ",is_term:!0,q_selected_eq:"LIKE",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"mints"})}}),e.form.item_factory({id:"findspot",name:"findspot",label:tstring.findspot||"findspot",q_column:"name",sql_filter:" name LIKE '%%' AND name !='' ",q_selected_eq:"LIKE",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"findspots"})}});const a=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:t});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:a}).addEventListener("click",(function(t){t.preventDefault(),e.form_submit()}));const o=e.form.build_operators_node();return t.appendChild(o),e.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline form_factory"}),e.form.node.appendChild(t),e.form.node},form_submit:function(){const e=this;if(!e.form.node)return new Promise((function(e){e(!1)}));for(;e.rows_container.hasChildNodes();)e.rows_container.removeChild(e.rows_container.lastChild);return new Promise((function(t){const n=["*"],a=e.form.build_filter();e.form.parse_sql_filter(a,[]);SHOW_DEBUG;let o=null,s=null,r=null,l="name";""!==e.form.form_items.mint.q||e.form.form_items.mint.q_selected.length>0?(o="mints",s=e.form.form_items.mint.q,r=e.form.form_items.mint.q_selected):""!==e.form.form_items.findspot.q||e.form.form_items.findspot.q_selected.length>0?(o="findspots",s=e.form.form_items.findspot.q,r=e.form.form_items.findspot.q_selected):(""!==e.form.form_items.collection.q||e.form.form_items.collection.q_selected.length>0)&&(o="coins",s=e.form.form_items.collection.q,r=e.form.form_items.collection.q_selected,l="collection");let m=` ${l} LIKE '%${""!==s?s:r}%' AND ${l} !=''`;o&&data_manager.request({body:{dedalo_get:"records",table:o,ar_fields:n,sql_filter:m,limit:0,count:!1,offset:0,order:"section_id ASC",process_result:null}}).then((async function(n){const a={lon:null,lat:null};if(n.result){e.map_container.classList.remove("loading");const t=JSON.parse(n.result[0].map);if(a.lat=t.lat,a.lon=t.lon,e.map_factory_instance.move_map_to_point(a),"mints"==n.result[0].table){const t=await e.cargarMonedasCecas(n.result[0].name);e.render_rows(n.result[0],t.result)}else{await e.cargarHijosHallazgos(n.result[0].section_id);e.render_rows_hallazgo(n.result[0])}}t(!0)}))}))},cargarMonedasCecas:async function(e){try{return await data_manager.request({body:{dedalo_get:"records",table:"coins",ar_fields:["*"],sql_filter:`mint_name LIKE '%${e}%'`,limit:15,count:!0,offset:0,order:"section_id ASC",process_result:null}})}catch(e){}},cargarHijosHallazgos:async function(e){try{return await data_manager.request({body:{dedalo_get:"records",table:"findspots",ar_fields:["*"],sql_filter:`parents LIKE '%"${e}"%'`,limit:0,count:!0,offset:0,order:"section_id ASC",process_result:null}})}catch(e){}},render_rows_hallazgo:function(e){const t=this,n=new DocumentFragment;let a=null,o=null;"mints"==e.table?(a="Ceca : "+e.name,o=","):(a="Hallazgo : "+e.name,o="-");const s=common.create_dom_element({element_type:"div",class_name:"container_title",parent:n}),r=(common.create_dom_element({element_type:"div",class_name:"line-tittle green-color",text_content:a,parent:s}),common.create_dom_element({element_type:"img",class_name:"imagen",src:"tpl/assets/images/arrow-right.svg",parent:s})),l=(common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:n}),common.create_dom_element({element_type:"div",class_name:"line-tittle mid",text_content:e.place.split(o)[0],parent:n}));l.style.display="none",r.addEventListener("mousedown",(function(){t.button_state?(r.style.transform="rotate(0deg) translateY(0.75vh)",l.style.display="none"):(r.style.transform="rotate(90deg) translateX(0.75vh)",l.style.display="block"),t.button_state=!t.button_state})),t.rows_container.appendChild(n)},render_rows:function(e,t){const n=this,a=new DocumentFragment;let o=null,s=null;"mints"==e.table?(o="Ceca : "+e.name,s=","):(o="Hallazgo : "+e.name,s="-");const r=common.create_dom_element({element_type:"div",class_name:"container_title",parent:a}),l=(common.create_dom_element({element_type:"div",class_name:"line-tittle green-color",text_content:o,parent:r}),common.create_dom_element({element_type:"img",class_name:"imagen",src:"tpl/assets/images/arrow-right.svg",parent:r})),m=(common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:a}),common.create_dom_element({element_type:"div",class_name:"line-tittle mid",text_content:e.place.split(s)[0],parent:a})),i=common.create_dom_element({element_type:"div",class_name:"container_text_rows",parent:a}),c=(common.create_dom_element({element_type:"div",class_name:"title_text_rows",text_content:"Monedas("+t.length+")",parent:i}),common.create_dom_element({element_type:"img",class_name:"imagen_text_rows",src:"tpl/assets/images/arrow-right.svg",parent:i})),_=common.create_dom_element({element_type:"div",class_name:"container_rows",parent:a});for(let e=0;e<t.length;e++){const n=common.create_dom_element({element_type:"div",class_name:"info_coin",parent:_}),a=common.create_dom_element({element_type:"div",class_name:"container_images",parent:n}),o=t[e],s="https://wondercoins.uca.es"+o.image_obverse;common.create_dom_element({element_type:"img",class_name:"img_observe",src:s,parent:a});const r="https://wondercoins.uca.es"+o.image_reverse;common.create_dom_element({element_type:"img",class_name:"img_reserve",src:r,parent:a});const l=common.create_dom_element({element_type:"div",class_name:"container_data",parent:n});let m=null;m=null!=t[e].weight?"Peso: "+t[e].weight+"g":"Peso: N/A";common.create_dom_element({element_type:"span",class_name:"weight",text_content:m,parent:l}),common.create_dom_element({element_type:"span",class_name:"diameter",text_content:"Módulo: "+t[e].diameter+"mm",parent:l}),common.create_dom_element({element_type:"span",class_name:"catalogue_type",text_content:"Colección: "+t[e].collection,parent:l});let i=t[e].findspot.split(" | ")[0];common.create_dom_element({element_type:"span",class_name:"findspot",text_content:"Hallazgo: "+i,parent:n}),common.create_dom_element({element_type:"span",class_name:"type",text_content:"Tipo: "+t[e].type_full_value,parent:n})}m.style.display="none",_.style.display="none";let d=!1;l.addEventListener("mousedown",(function(){n.button_state?(l.style.transform="rotate(0deg) translateY(0.75vh)",m.style.display="none"):(l.style.transform="rotate(90deg) translateX(0.75vh)",m.style.display="block"),n.button_state=!n.button_state})),c.addEventListener("mousedown",(function(){d?(c.style.transform="rotate(0deg) translateY(0.60vh)",_.style.display="none"):(c.style.transform="rotate(90deg) translateX(0.60vh)",_.style.display="grid"),d=!d})),n.rows_container.appendChild(a)}};