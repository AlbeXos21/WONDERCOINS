"use strict";var map={form_container:null,rows_container:null,map_container:null,export_data_container:null,map_factory_instance:null,master_map_global_data:null,current_map_global_data:null,global_data:null,map_global_data:null,form:null,forn_node:null,map_config:null,button_state:!1,set_up:function(options){SHOW_DEBUG;const self=this;self.form_container=options.form_container,self.map_container=options.map_container,self.rows_container=options.rows_container,self.export_data_container=options.export_data_container;const export_data_buttons=page.render_export_data_buttons();self.export_data_container.appendChild(export_data_buttons),self.export_data_container.classList.add("hide");let resultado={hallazgos:{datos:[]},cecas:{datos:[]},complejo:{datos:[]}};this.cargarTodoYCrearMapa(resultado),self.form=new form_factory;const form_node=self.render_form();self.form_container.appendChild(form_node),self.set_config();const show_search_button=document.getElementById("search_icon");return show_search_button.addEventListener("mousedown",(function(){let new_showing_search;!0===self.map_config.showing_search?(form_node.classList.add("hide"),new_showing_search=!1):(form_node.classList.remove("hide"),new_showing_search=!0),self.set_config({showing_search:new_showing_search})})),!0===self.map_config.showing_search?form_node.classList.remove("hide"):form_node.classList.add("hide"),!0},cargarTodoYCrearMapa:async function(resultado){const self=this;try{const hallazgos=await data_manager.request({body:{dedalo_get:"records",table:"findspots",ar_fields:["*"],sql_filter:"",limit:0,count:!0,offset:0,order:"section_id ASC",process_result:null}});resultado.hallazgos.datos=hallazgos.result;const cecas=await data_manager.request({body:{dedalo_get:"records",table:"mints",ar_fields:["*"],sql_filter:"",limit:0,count:!0,offset:0,order:"name",process_result:null}});resultado.cecas.datos=cecas.result,self.map_factory_instance=new map_factory,self.map_factory_instance.init({map_container:self.map_container,map_position:[36.5297,-6.2924],source_maps:page.maps_config.source_maps,result:resultado,map_node:this})}catch(error){console.error("Error cargando datos:",error)}},set_config:function(options){const self=this,map_config=localStorage.getItem("map_config");if(map_config)self.map_config=JSON.parse(map_config);else{const map_config={showing_search:!1};localStorage.setItem("map_config",JSON.stringify(map_config)),self.map_config=map_config}if(options){for(const key in options)self.map_config[key]=options[key];localStorage.setItem("map_config",JSON.stringify(self.map_config))}return self.map_config},render_form:function(){const self=this,fragment=new DocumentFragment,form_row=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:fragment});common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:form_row}),self.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"name",value_wrapper:['["','"]'],sql_filter:" name LIKE '%%' AND name !='' ",is_term:!0,q_selected_eq:"LIKE",parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"mints"})}}),self.form.item_factory({id:"findspot",name:"findspot",label:tstring.findspot||"findspot",q_column:"name",sql_filter:" name LIKE '%%' AND name !='' ",q_selected_eq:"LIKE",parent:form_row,callback:function(form_item){self.form.activate_autocomplete({form_item:form_item,table:"findspots"})}});const submit_group=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:fragment}),submit_button=common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:submit_group});submit_button.addEventListener("click",(function(e){e.preventDefault(),self.form_submit()}));const operators_node=self.form.build_operators_node();return fragment.appendChild(operators_node),self.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline form_factory"}),self.form.node.appendChild(fragment),self.form.node},form_submit:function(){const self=this,form_node=self.form.node;if(!form_node)return new Promise((function(resolve){console.error("Error on submit. Invalid form_node.",form_node),resolve(!1)}));for(;self.rows_container.hasChildNodes();)self.rows_container.removeChild(self.rows_container.lastChild);return new Promise((function(resolve){const ar_fields=["*"],filter=self.form.build_filter(),group=[],parsed_filter=self.form.parse_sql_filter(filter,group),sql_filter=parsed_filter?"("+parsed_filter+")":null;SHOW_DEBUG;let table=null,q=null,q_selected=null,label="name";""!==self.form.form_items.mint.q||self.form.form_items.mint.q_selected.length>0?(table="mints",q=self.form.form_items.mint.q,q_selected=self.form.form_items.mint.q_selected):""!==self.form.form_items.findspot.q||self.form.form_items.findspot.q_selected.length>0?(table="findspots",q=self.form.form_items.findspot.q,q_selected=self.form.form_items.findspot.q_selected):(""!==self.form.form_items.collection.q||self.form.form_items.collection.q_selected.length>0)&&(table="coins",q=self.form.form_items.collection.q,q_selected=self.form.form_items.collection.q_selected,label="collection");let sql_filter_final=` ${label} LIKE '%${""!==q?q:q_selected}%' AND ${label} !=''`;console.log("El sql filter es "+sql_filter_final+" "+table),table&&data_manager.request({body:{dedalo_get:"records",table:table,ar_fields:ar_fields,sql_filter:sql_filter_final,limit:0,count:!1,offset:0,order:"section_id ASC",process_result:null}}).then((async function(api_response){const location={lon:null,lat:null};if(api_response.result){self.map_container.classList.remove("loading");const datos_location=JSON.parse(api_response.result[0].map);location.lat=datos_location.lat,location.lon=datos_location.lon,self.map_factory_instance.move_map_to_point(location),self.render_rows(api_response.result[0])}resolve(!0)}))}))},cargarMonedasCecas:async function(ceca){try{const monedas=await data_manager.request({body:{dedalo_get:"records",table:"coins",ar_fields:["*"],sql_filter:`mint_name LIKE '%${ceca}%'`,limit:15,count:!0,offset:0,order:"section_id ASC",process_result:null}});return monedas}catch(error){console.error("Error cargando datos:",error)}},cargarHijosHallazgos:async function(hallazgo){try{const hijos=await data_manager.request({body:{dedalo_get:"records",table:"findspots",ar_fields:["*"],sql_filter:`parents LIKE '%"${hallazgo}"%'`,limit:0,count:!0,offset:0,order:"section_id ASC",process_result:null}});return hijos}catch(error){console.error("Error cargando datos:",error)}},createfindspot_Tree:async function(findspot){const findspots_tree=[],findspot_sons=await this.cargarHijosHallazgos(findspot.section_id);findspots_tree.push({info_nodo:findspot,padre:null});for(let index=0;index<findspot_sons.result.length;index++){const parent_node=JSON.parse(findspot_sons.result[index].parents);findspots_tree.push({info_nodo:findspot_sons.result[index],padre:parent_node[0]})}return findspots_tree},generate_Tree:function(tree,node,node_parent,padding){const info_node=common.create_dom_element({element_type:"div",class_name:"container_prueba",text_content:node.info_nodo.name,parent:node_parent});if(info_node.style.paddingLeft=`${padding}em`,null==node.info_nodo.children);else for(let index=0;index<tree.length;index++)tree[index].info_nodo.parent=='["'+node.info_nodo.section_id+'"]'&&(tree[index].padre="'"+node.info_nodo.section_id+"'",this.generate_Tree(tree,tree[index],info_node,1.5))},render_rows:async function(row){if("mints"===row.table){const coins=await this.cargarMonedasCecas(row.name);await this.render_rows_cecas(row,coins.result)}else await this.render_rows_hallazgo(row)},render_rows_hallazgo:async function(row){const self=this,fragment=new DocumentFragment;let text_content=null,separador=null;text_content="Hallazgo : "+row.name,separador="-";const container_titulo=common.create_dom_element({element_type:"div",class_name:"container_title",parent:fragment}),titulo=common.create_dom_element({element_type:"div",class_name:"line-tittle green-color",text_content:text_content,parent:container_titulo}),imagen=common.create_dom_element({element_type:"img",class_name:"imagen",src:"tpl/assets/images/arrow-right.svg",parent:container_titulo}),separator=common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:fragment}),road=common.create_dom_element({element_type:"div",class_name:"line-tittle mid",text_content:row.place.split("-")[0],parent:fragment}),findspot_tree=await this.createfindspot_Tree(row);console.log(findspot_tree),this.generate_Tree(findspot_tree,findspot_tree[0],fragment,0),road.style.display="none",imagen.addEventListener("mousedown",(function(){self.button_state?(imagen.style.transform="rotate(0deg) translateY(0.75vh)",road.style.display="none"):(imagen.style.transform="rotate(90deg) translateX(0.75vh)",road.style.display="block"),self.button_state=!self.button_state})),self.rows_container.appendChild(fragment)},render_rows_cecas:async function(row,coins){const self=this,fragment=new DocumentFragment;let text_content=null,separador=null;text_content="Ceca : "+row.name,separador=",";const container_titulo=common.create_dom_element({element_type:"div",class_name:"container_title",parent:fragment}),titulo=common.create_dom_element({element_type:"div",class_name:"line-tittle green-color",text_content:text_content,parent:container_titulo}),imagen=common.create_dom_element({element_type:"img",class_name:"imagen",src:"tpl/assets/images/arrow-right.svg",parent:container_titulo}),separator=common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:fragment}),road=common.create_dom_element({element_type:"div",class_name:"line-tittle mid",text_content:row.place.split(",")[0],parent:fragment}),container_text_rows=common.create_dom_element({element_type:"div",class_name:"container_text_rows",parent:fragment}),title_text_rows=common.create_dom_element({element_type:"div",class_name:"title_text_rows",text_content:"Monedas("+coins.length+")",parent:container_text_rows}),imagen_flecha_monedas=common.create_dom_element({element_type:"img",class_name:"imagen_text_rows",src:"tpl/assets/images/arrow-right.svg",parent:container_text_rows}),container_rows=common.create_dom_element({element_type:"div",class_name:"container_rows",parent:fragment});for(let index=0;index<coins.length;index++){const info_coin=common.create_dom_element({element_type:"div",class_name:"info_coin",parent:container_rows}),container_images=common.create_dom_element({element_type:"div",class_name:"container_images",parent:info_coin}),parsedCoinData=coins[index],image_obverse="https://wondercoins.uca.es"+parsedCoinData.image_obverse;common.create_dom_element({element_type:"img",class_name:"img_observe",src:image_obverse,parent:container_images});const image_reverse="https://wondercoins.uca.es"+parsedCoinData.image_reverse;common.create_dom_element({element_type:"img",class_name:"img_reserve",src:image_reverse,parent:container_images});const container_data=common.create_dom_element({element_type:"div",class_name:"container_data",parent:info_coin});let weight_text=null;weight_text=null!=coins[index].weight?"Peso: "+coins[index].weight+"g":"Peso: N/A";const weight=common.create_dom_element({element_type:"span",class_name:"weight",text_content:weight_text,parent:container_data}),diameter=common.create_dom_element({element_type:"span",class_name:"diameter",text_content:"Módulo: "+coins[index].diameter+"mm",parent:container_data}),catalogue_type=common.create_dom_element({element_type:"span",class_name:"catalogue_type",text_content:"Colección: "+coins[index].collection,parent:container_data});let findspot_text=coins[index].findspot.split(" | ")[0];const findspot=common.create_dom_element({element_type:"span",class_name:"findspot",text_content:"Hallazgo: "+findspot_text,parent:info_coin}),tipo=common.create_dom_element({element_type:"span",class_name:"type",text_content:"Tipo: "+coins[index].type_full_value,parent:info_coin}),container_links=common.create_dom_element({element_type:"div",class_name:"container_links",parent:info_coin}),type_link=common.create_dom_element({element_type:"a",class_name:"type_link",href:"/web_numisdata/type/"+coins[index].type,text_content:"TIPO",parent:container_links})}road.style.display="none",container_rows.style.display="none";let container_rows_state=!1;imagen.addEventListener("mousedown",(function(){self.button_state?(imagen.style.transform="rotate(0deg) translateY(0.75vh)",road.style.display="none"):(imagen.style.transform="rotate(90deg) translateX(0.75vh)",road.style.display="block"),self.button_state=!self.button_state})),imagen_flecha_monedas.addEventListener("mousedown",(function(){container_rows_state?(imagen_flecha_monedas.style.transform="rotate(0deg) translateY(0.60vh)",container_rows.style.display="none"):(imagen_flecha_monedas.style.transform="rotate(90deg) translateX(0.60vh)",container_rows.style.display="grid"),container_rows_state=!container_rows_state})),self.rows_container.appendChild(fragment)}};