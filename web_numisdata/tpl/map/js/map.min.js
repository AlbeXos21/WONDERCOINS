"use strict";var map={form_container:null,rows_container:null,map_container:null,export_data_container:null,map_factory_instance:null,master_map_global_data:null,current_map_global_data:null,global_data:null,map_global_data:null,form:null,forn_node:null,map_config:null,button_state:!1,set_up:function(e){SHOW_DEBUG;const t=this;t.form_container=e.form_container,t.map_container=e.map_container,t.rows_container=e.rows_container,t.export_data_container=e.export_data_container;const n=page.render_export_data_buttons();t.export_data_container.appendChild(n),t.export_data_container.classList.add("hide"),t.source_maps=[{name:"OSM",url:"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{maxZoom:19}},{name:"Map Tiles",url:"https://api.maptiler.com/maps/basic/256/{z}/{x}/{y}@2x.png?key=udlBrEEE2SPm1In5dCNb",options:{maxZoom:20},default:!0},{name:"ARCGIS",url:"//server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{}}];let o={hallazgos:{datos:null},cecas:{datos:null},complejo:{datos:null}};this.cargarTodoYCrearMapa(o),t.form=new form_factory;const a=t.render_form();t.form_container.appendChild(a),t.set_config();const r=document.getElementById("search_icon");return r.addEventListener("mousedown",function(){let e;!0===t.map_config.showing_search?(a.classList.add("hide"),e=!1):(a.classList.remove("hide"),e=!0),t.set_config({showing_search:e})}),!0===t.map_config.showing_search?a.classList.remove("hide"):a.classList.add("hide"),!0},cargarTodoYCrearMapa:async function(e){const t=this;try{const n=await data_manager.request({body:{dedalo_get:"records",table:"findspots",ar_fields:["*"],sql_filter:"",limit:0,count:!0,offset:0,order:"section_id ASC",process_result:null}});e.hallazgos.datos=n.result;const o=await data_manager.request({body:{dedalo_get:"records",table:"mints",ar_fields:["*"],sql_filter:"",limit:0,count:!0,offset:0,order:"name",process_result:null}});e.cecas.datos=o.result,t.map_factory_instance=new map_factory,t.map_factory_instance.init({map_container:t.map_container,map_position:[36.5297,-6.2924],source_maps:t.source_maps,result:e,map_node:this})}catch(e){console.error("Error cargando datos:",e)}},set_config:function(e){const t=this,n=localStorage.getItem("map_config");if(n)t.map_config=JSON.parse(n);else{const e={showing_search:!1};localStorage.setItem("map_config",JSON.stringify(e)),t.map_config=e}if(e){for(const n in e)t.map_config[n]=e[n];localStorage.setItem("map_config",JSON.stringify(t.map_config))}return t.map_config},render_form:function(){const e=this,t=new DocumentFragment,n=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:t});common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:n}),e.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"name",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,q_selected_eq:"LIKE",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"mints"})}}),e.form.item_factory({id:"findspot",name:"findspot",label:tstring.findspot||"findspot",q_column:"name",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"findspots"})}});const o=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:t}),a=common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:o});a.addEventListener("click",function(t){t.preventDefault(),e.form_submit()});const r=e.form.build_operators_node();return t.appendChild(r),e.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline form_factory"}),e.form.node.appendChild(t),e.form.node},form_submit:function(){const e=this,t=e.form.node;if(!t)return new Promise(function(e){console.error("Error on submit. Invalid form_node.",t),e(!1)});for(;e.rows_container.hasChildNodes();)e.rows_container.removeChild(e.rows_container.lastChild);return new Promise(function(t){const n=["*"],o=e.form.build_filter(),a=[];e.form.parse_sql_filter(o,a);SHOW_DEBUG;let r=null,s=null,l=null,m="name";""!==e.form.form_items.mint.q||e.form.form_items.mint.q_selected.length>0?(r="mints",s=e.form.form_items.mint.q,l=e.form.form_items.mint.q_selected):""!==e.form.form_items.findspot.q||e.form.form_items.findspot.q_selected.length>0?(r="findspots",s=e.form.form_items.findspot.q,l=e.form.form_items.findspot.q_selected):(""!==e.form.form_items.collection.q||e.form.form_items.collection.q_selected.length>0)&&(r="coins",s=e.form.form_items.collection.q,l=e.form.form_items.collection.q_selected,m="collection");let i=` ${m} LIKE '%${""!==s?s:l}%' AND ${m} !=''`;"findspots"==r&&(i+=" OR typology = tchi2_3"),console.log("El sql filter es "+i),r&&data_manager.request({body:{dedalo_get:"records",table:r,ar_fields:n,sql_filter:i,limit:0,count:!1,offset:0,order:"section_id ASC",process_result:null}}).then(async function(n){const o={lon:null,lat:null};if(n.result){e.map_container.classList.remove("loading");const t=JSON.parse(n.result[0].map);if(o.lat=t.lat,o.lon=t.lon,e.map_factory_instance.move_map_to_point(o),"mints"==n.result[0].table){const t=await e.cargarMonedasCecas(n.result[0].name);e.render_rows(n.result[0],t.result),console.log(t)}else e.render_rows(n.result[0])}t(!0)})})},cargarMonedasCecas:async function(e){try{const t=await data_manager.request({body:{dedalo_get:"records",table:"coins",ar_fields:["*"],sql_filter:`mint_name LIKE '%${e}%'`,limit:15,count:!0,offset:0,order:"section_id ASC",process_result:null}});return t}catch(e){console.error("Error cargando datos:",e)}},render_rows:function(e){const t=this,n=new DocumentFragment;let o=null,a=null;"mints"==e.table?(o="Ceca : "+e.name,a=","):(o="Hallazgo : "+e.name,a="-");const r=common.create_dom_element({element_type:"div",class_name:"container_title",parent:n}),s=(common.create_dom_element({element_type:"div",class_name:"line-tittle green-color",text_content:o,parent:r}),common.create_dom_element({element_type:"img",class_name:"imagen",src:"tpl/assets/images/arrow-right.svg",parent:r})),l=(common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:n}),common.create_dom_element({element_type:"div",class_name:"line-tittle mid",text_content:e.place.split(a)[0],parent:n}));l.style.display="none",s.addEventListener("mousedown",function(){t.button_state?(s.style.transform="rotate(0deg) translateY(0.75vh)",l.style.display="none"):(s.style.transform="rotate(90deg) translateX(0.75vh)",l.style.display="block"),t.button_state=!t.button_state}),t.rows_container.appendChild(n)},render_rows:function(e,t){const n=this,o=new DocumentFragment;let a=null,r=null;"mints"==e.table?(a="Ceca : "+e.name,r=","):(a="Hallazgo : "+e.name,r="-");const s=common.create_dom_element({element_type:"div",class_name:"container_title",parent:o}),l=(common.create_dom_element({element_type:"div",class_name:"line-tittle green-color",text_content:a,parent:s}),common.create_dom_element({element_type:"img",class_name:"imagen",src:"tpl/assets/images/arrow-right.svg",parent:s})),m=(common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:o}),common.create_dom_element({element_type:"div",class_name:"line-tittle mid",text_content:e.place.split(r)[0],parent:o})),i=common.create_dom_element({element_type:"div",class_name:"container_text_rows",parent:o}),c=(common.create_dom_element({element_type:"div",class_name:"title_text_rows",text_content:"Monedas("+t.length+")",parent:i}),common.create_dom_element({element_type:"img",class_name:"imagen_text_rows",src:"tpl/assets/images/arrow-right.svg",parent:i})),_=common.create_dom_element({element_type:"div",class_name:"container_rows",parent:o});for(let e=0;e<t.length;e++){const n=common.create_dom_element({element_type:"div",class_name:"info_coin",parent:_}),o=common.create_dom_element({element_type:"div",class_name:"container_images",parent:n}),a=t[e],r="https://wondercoins.uca.es"+a.image_obverse;common.create_dom_element({element_type:"img",class_name:"img_observe",src:r,parent:o});const s="https://wondercoins.uca.es"+a.image_reverse;common.create_dom_element({element_type:"img",class_name:"img_reserve",src:s,parent:o})}m.style.display="none",_.style.display="none";let d=!1;l.addEventListener("mousedown",function(){n.button_state?(l.style.transform="rotate(0deg) translateY(0.75vh)",m.style.display="none"):(l.style.transform="rotate(90deg) translateX(0.75vh)",m.style.display="block"),n.button_state=!n.button_state}),c.addEventListener("mousedown",function(){d?(c.style.transform="rotate(0deg) translateY(0.60vh)",_.style.display="none"):(c.style.transform="rotate(90deg) translateX(0.60vh)",_.style.display="grid"),d=!d}),n.rows_container.appendChild(o)}};