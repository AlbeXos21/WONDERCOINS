"use strict";var biblio={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/biblio/trigger.biblio.php",search_options:null,set_up:function(){const self=this,form=document.getElementById("search_form");if(form){const ar_form_inputs=form.querySelectorAll("input.form-control"),ar_form_inputs_len=ar_form_inputs.length;for(let i=0;i<ar_form_inputs_len;i++){const item=ar_form_inputs[i],autocomplete=!item.dataset.autocomplete||JSON.parse(item.dataset.autocomplete);!0===autocomplete&&self.activate_autocomplete(ar_form_inputs[i])}self.search_rows({ar_query:[],limit:20})}else if("undefined"!=typeof biblio_section_id){const ar_query=[],current_obj={name:"section_id",value:biblio_section_id,search_mode:"string",table:"publicaciones"};ar_query.push(current_obj),self.search_rows({ar_query:ar_query,limit:1})}return!0},set_value:function(object,value){const container=document.getElementById(object.id+"_values"),inputs=container.querySelectorAll(".input_values"),inputs_length=inputs.length;for(let i=inputs_length-1;i>=0;i--)if(value===inputs[i].value)return!1;const line=common.create_dom_element({element_type:"div",class_name:"line_value",parent:container}),trash=common.create_dom_element({element_type:"i",class_name:"icon fa-trash",parent:line});trash.addEventListener("click",(function(){this.parentNode.remove()}));const input=common.create_dom_element({element_type:"input",class_name:"input_values",parent:line,data_set:object.dataset});return input.value=value,!0},activate_autocomplete:function(element){const self=this;return $(element).autocomplete({delay:150,minLength:0,source:function(request,response){const term=request.term,trigger_url=self.trigger_url,trigger_vars={q:term,mode:element.dataset.mode,q_name:element.dataset.q_name||null,q_search:element.dataset.q_search||element.dataset.q_name,q_table:element.dataset.q_table||null,dd_relations:element.dataset.dd_relations||null,limit:element.dataset.limit||30};SHOW_DEBUG,common.get_json_data(trigger_url,trigger_vars).then((function(response_data){let result_final=[];if("descriptors_rec"===element.id){const len=response_data.result.length;for(let i=0;i<len;i++){const item=response_data.result[i],terms=item.label.split(" - ");for(let k=0;k<terms.length;k++){const term_name=terms[k].trim(),found=result_final.find(el=>el.value===term_name);!found&&term_name.length>0&&(console.log("PUSH",term_name),result_final.push({label:term_name,value:term_name}))}}const ar_ordered_result=page.sort_array_by_property(result_final,"value"),ar_filtered_result=0!=term.length?page.filter_drop_down_list(ar_ordered_result,term):ar_ordered_result,ar_drow_down_list=ar_filtered_result.slice(0,30);result_final=ar_drow_down_list}else result_final="fecha_publicacion"===element.id?response_data.result.map(item=>(item.label=item.label.substring(0,4),item)):response_data.result;response(result_final)}),(function(error){console.error("[activate_autocomplete] Failed get_json!",error)}))},select:function(event,ui){return event.preventDefault(),self.set_value(this,ui.item.label,ui.item.value),this.value="",!1},focus:function(){return!1},close:function(event,ui){},change:function(event,ui){},response:function(event,ui){}}).on("keydown",(function(event){event.keyCode===$.ui.keyCode.ENTER&&$(this).autocomplete("close")})).focus((function(){$(this).autocomplete("search",null)})).blur((function(){})),!0},search:function(form_obj,event){event&&event.preventDefault();const self=this;for(var ar_query=[],ar_form_inputs=form_obj.querySelectorAll("input.input_values, input.form-control"),ar_input_len=ar_form_inputs.length,i=0;i<ar_input_len;i++){const input=ar_form_inputs[i];if(input.value.length>0){let current_value=input.value,current_column=input.dataset.q_name;if(-1!==input.dataset.q_name.indexOf(" AS ")){const ar_parts=input.dataset.q_name.split(" AS ");current_column=ar_parts[1]}console.log("current_column",current_column);const current_obj={name:current_column,value:current_value,search_mode:input.dataset.search,table:input.dataset.q_table};ar_query.push(current_obj)}}SHOW_DEBUG;const operators_value=form_obj.querySelector('input[name="operators"]:checked').value,response=this.search_rows({ar_query:ar_query,operator:operators_value}),div_result=document.querySelector(".result");return div_result&&div_result.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),response},search_rows:function(options){const self=this;this.search_options=options;const container=document.getElementById("biblio_rows_list");container.style.opacity="0.4";const trigger_url=this.trigger_url,trigger_vars={mode:"search_rows",ar_query:void 0!==options.ar_query?options.ar_query:null,limit:options.limit||20,offset:options.offset||0,count:options.count||!1,total:options.total||!1,order:options.order||"section_id ASC",operator:options.operator||"$or"};SHOW_DEBUG;const js_promise=common.get_json_data(trigger_url,trigger_vars).then((function(response){return SHOW_DEBUG,container.style.opacity="1",response?biblio.draw_rows({target:"biblio_rows_list",ar_rows:response.result.result,total:response.result.total,limit:trigger_vars.limit,offset:trigger_vars.offset}):(console.warn("[biblio.search_rows] Error. Received response data is null"),!1)}));return js_promise},search_item:function(name,value){const self=this,ar_query=[{name:name,search_mode:"string",table:"publications",value:value}],count=!0;return this.search_rows({ar_query:ar_query,count:!0}).then((function(){const div_result=document.querySelector(".result");div_result&&div_result.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}))},draw_rows:function(options){const self=this,ar_rows=options.ar_rows||[],ar_rows_length=ar_rows.length,container=document.getElementById(options.target);for(;container.hasChildNodes();)container.removeChild(container.lastChild);const fragment=new DocumentFragment,pagination_container=common.create_dom_element({element_type:"div",class_name:"pagination top"});pagination_container.appendChild(self.draw_paginator({total:options.total,limit:options.limit,offset:options.offset,count:ar_rows_length})),fragment.appendChild(pagination_container);const collator=new Intl.Collator("es",{sensitivity:"base",ignorePunctuation:!0});ar_rows.sort((a,b)=>{let order_a=a.authors+" "+a.publication_date,order_b=b.authors+" "+b.publication_date;return collator.compare(order_a,order_b)});for(let i=0;i<ar_rows_length;i++){const biblio_object=ar_rows[i];SHOW_DEBUG;const biblio_row_wrapper=common.create_dom_element({element_type:"div",class_name:"biblio_row_wrapper",data_set:{section_id:biblio_object.section_id},parent:fragment}),row_field=biblio_row_fields;if(row_field.biblio_object=biblio_object,row_field.caller=self,biblio_row_wrapper.appendChild(row_field.author()),biblio_row_wrapper.appendChild(row_field.publication_date()),biblio_row_wrapper.appendChild(row_field.row_title()),biblio_row_wrapper.appendChild(row_field.row_body()),biblio_row_wrapper.appendChild(row_field.row_url()),biblio_object.descriptors&&biblio_object.descriptors.length>1&&biblio_row_wrapper.appendChild(row_field.descriptors(biblio_object.descriptors)),biblio_object.transcription){const transcription_node=row_field.transcription(biblio_object.transcription);transcription_node&&biblio_row_wrapper.appendChild(transcription_node)}}const pagination_container_bottom=common.create_dom_element({element_type:"div",class_name:"pagination bottom"});return pagination_container_bottom.appendChild(self.draw_paginator({total:options.total,limit:options.limit,offset:options.offset,count:ar_rows_length})),fragment.appendChild(pagination_container_bottom),container.appendChild(fragment),!0},draw_paginator:function(options){const self=this,pagination_fragment=new DocumentFragment,paginator_node=paginator.get_full_paginator({total:options.total,limit:options.limit,offset:options.offset,n_nodes:6,callback:item=>{const offset=item.offset,total=item.total;self.search_options.offset=offset,self.search_options.total=total;const search=self.search_rows(self.search_options);return search.then((function(){const div_result=document.querySelector(".result");div_result&&div_result.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})})),search}});pagination_fragment.appendChild(paginator_node),common.create_dom_element({element_type:"div",class_name:"spacer",parent:pagination_fragment});const totals_node=paginator.get_totals_node({total:options.total,limit:options.limit,offset:options.offset,count:options.count});return pagination_fragment.appendChild(totals_node),pagination_fragment},createExpandableBlock:function(){const textBlock=document.querySelector("#body-txt"),nodeParent=document.querySelector("#body-txt-parent");textBlock.classList.add("contracted-block");const textBlockSeparator=common.create_dom_element({element_type:"div",class_name:"text-block-separator",parent:nodeParent}),separatorArrow=common.create_dom_element({element_type:"div",class_name:"separator-arrow",parent:textBlockSeparator});textBlockSeparator.addEventListener("click",(function(){textBlock.classList.contains("contracted-block")?(textBlock.classList.remove("contracted-block"),separatorArrow.style.transform="rotate(-90deg)"):(textBlock.classList.add("contracted-block"),separatorArrow.style.transform="rotate(90deg)")}))}};