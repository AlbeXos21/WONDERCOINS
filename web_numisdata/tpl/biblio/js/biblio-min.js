"use strict";var biblio={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/biblio/trigger.biblio.php",search_options:null,set_up:function(){const e=this,t=document.getElementById("search_form");if(t){const o=t.querySelectorAll("input.form-control"),n=o.length;for(let t=0;t<n;t++){const n=o[t],a=!n.dataset.autocomplete||JSON.parse(n.dataset.autocomplete);!0===a&&e.activate_autocomplete(o[t])}e.search_rows({ar_query:[],limit:20})}else if("undefined"!=typeof biblio_section_id){const t=[],o={name:"section_id",value:biblio_section_id,search_mode:"string",table:"publicaciones"};t.push(o),e.search_rows({ar_query:t,limit:1})}return e.createExpandableBlock(),!0},set_value:function(e,t){const o=document.getElementById(e.id+"_values"),n=o.querySelectorAll(".input_values"),a=n.length;for(let e=a-1;e>=0;e--)if(t===n[e].value)return!1;const r=common.create_dom_element({element_type:"div",class_name:"line_value",parent:o}),l=common.create_dom_element({element_type:"i",class_name:"icon fa-trash",parent:r});l.addEventListener("click",function(){this.parentNode.remove()});const s=common.create_dom_element({element_type:"input",class_name:"input_values",parent:r,data_set:e.dataset});return s.value=t,!0},activate_autocomplete:function(e){const t=this;return $(e).autocomplete({delay:150,minLength:0,source:function(o,n){const a=o.term,r=t.trigger_url,l={q:a,mode:e.dataset.mode,q_name:e.dataset.q_name||null,q_search:e.dataset.q_search||e.dataset.q_name,q_table:e.dataset.q_table||null,dd_relations:e.dataset.dd_relations||null,limit:e.dataset.limit||30};SHOW_DEBUG,common.get_json_data(r,l).then(function(t){let o=[];if("descriptors_rec"===e.id){const e=t.result.length;for(let n=0;n<e;n++){const e=t.result[n],a=e.label.split(" - ");for(let e=0;e<a.length;e++){const t=a[e].trim(),n=o.find(e=>e.value===t);!n&&t.length>0&&o.push({label:t,value:t})}}const n=page.sort_array_by_property(o,"value"),r=0!=a.length?page.filter_drop_down_list(n,a):n,l=r.slice(0,30);o=l}else o="fecha_publicacion"===e.id?t.result.map(e=>(e.label=e.label.substring(0,4),e)):t.result;n(o)},function(e){console.error("[activate_autocomplete] Failed get_json!",e)})},select:function(e,o){return e.preventDefault(),t.set_value(this,o.item.label,o.item.value),this.value="",!1},focus:function(){return!1},close:function(e,t){},change:function(e,t){},response:function(e,t){}}).on("keydown",function(e){e.keyCode===$.ui.keyCode.ENTER&&$(this).autocomplete("close")}).focus(function(){$(this).autocomplete("search",null)}).blur(function(){}),!0},search:function(e,t){t&&t.preventDefault();const o=this;for(var n=[],a=e.querySelectorAll("input.input_values, input.form-control"),r=a.length,l=0;l<r;l++){const e=a[l];if(e.value.length>0){let t=e.value,o=e.dataset.q_name;if(-1!==e.dataset.q_name.indexOf(" AS ")){const t=e.dataset.q_name.split(" AS ");o=t[1]}const a={name:o,value:t,search_mode:e.dataset.search,table:e.dataset.q_table};n.push(a)}}SHOW_DEBUG;const s=e.querySelector('input[name="operators"]:checked').value,i=o.search_rows({ar_query:n,operator:s}),c=document.querySelector(".result");return c&&c.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"}),i},search_rows:function(e){const t=this;t.search_options=e;const o=document.getElementById("biblio_rows_list");o.style.opacity="0.4";const n=t.trigger_url,a={mode:"search_rows",ar_query:void 0!==e.ar_query?e.ar_query:null,limit:e.limit||20,offset:e.offset||0,count:e.count||!1,total:e.total||!1,order:e.order||"section_id ASC",operator:e.operator||"$or"};SHOW_DEBUG;const r=common.get_json_data(n,a).then(function(e){return SHOW_DEBUG,o.style.opacity="1",e?biblio.draw_rows({target:"biblio_rows_list",ar_rows:e.result.result,total:e.result.total,limit:a.limit,offset:a.offset}):(console.warn("[biblio.search_rows] Error. Received response data is null"),!1)});return r},search_item:function(e,t){const o=this,n=[{name:e,search_mode:"string",table:"publications",value:t}],a=!0;return o.search_rows({ar_query:n,count:a}).then(function(){const e=document.querySelector(".result");e&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})})},draw_rows:function(e){const t=this,o=e.ar_rows||[],n=o.length,a=document.getElementById(e.target);for(;a.hasChildNodes();)a.removeChild(a.lastChild);const r=new DocumentFragment,l=common.create_dom_element({element_type:"div",class_name:"pagination top"});l.appendChild(t.draw_paginator({total:e.total,limit:e.limit,offset:e.offset,count:n})),r.appendChild(l);const s=new Intl.Collator("es",{sensitivity:"base",ignorePunctuation:!0});o.sort((e,t)=>{let o=e.authors+" "+e.publication_date,n=t.authors+" "+t.publication_date;return s.compare(o,n)});for(let e=0;e<n;e++){const n=o[e];SHOW_DEBUG;const a=common.create_dom_element({element_type:"div",class_name:"biblio_row_wrapper",data_set:{section_id:n.section_id},parent:r}),l=biblio_row_fields;if(l.biblio_object=n,l.caller=t,a.appendChild(l.author()),a.appendChild(l.publication_date()),a.appendChild(l.row_title()),a.appendChild(l.row_body()),a.appendChild(l.row_url()),n.descriptors&&n.descriptors.length>1&&a.appendChild(l.descriptors(n.descriptors)),n.transcription){const e=l.transcription(n.transcription);e&&a.appendChild(e)}}const i=common.create_dom_element({element_type:"div",class_name:"pagination bottom"});return i.appendChild(t.draw_paginator({total:e.total,limit:e.limit,offset:e.offset,count:n})),r.appendChild(i),a.appendChild(r),!0},draw_paginator:function(e){const t=this,o=new DocumentFragment,n=paginator.get_full_paginator({total:e.total,limit:e.limit,offset:e.offset,n_nodes:6,callback:e=>{const o=e.offset,n=e.total;t.search_options.offset=o,t.search_options.total=n;const a=t.search_rows(t.search_options);return a.then(function(){const e=document.querySelector(".result");e&&e.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}),a}});o.appendChild(n),common.create_dom_element({element_type:"div",class_name:"spacer",parent:o});const a=paginator.get_totals_node({total:e.total,limit:e.limit,offset:e.offset,count:e.count});return o.appendChild(a),o},createExpandableBlock:function(){const e=document.querySelector("#body-txt"),t=document.querySelector("#body-txt-parent");e.classList.add("contracted-block");const o=common.create_dom_element({element_type:"div",class_name:"text-block-separator",parent:t}),n=common.create_dom_element({element_type:"div",class_name:"separator-arrow",parent:o});o.addEventListener("click",function(){e.classList.contains("contracted-block")?(e.classList.remove("contracted-block"),n.style.transform="rotate(-90deg)"):(e.classList.add("contracted-block"),n.style.transform="rotate(90deg)")})}};