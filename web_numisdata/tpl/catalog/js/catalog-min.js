"use strict";var catalog={trigger_url:page_globals.__WEB_TEMPLATE_WEB__+"/catalog/trigger.catalog.php",search_options:{},selected_term_table:null,filters:{},filter_op:"AND",draw_delay:1,form:null,rows_list_container:null,export_data_container:null,set_up:function(e){const t=this,r=e.rows_list_container,n=e.export_data_container,a=e.form_items_container,o=e.psqo;t.rows_list_container=r,t.export_data_container=n,t.form_items_container=a;const _=t.render_form();if(t.form_items_container.appendChild(_),o&&o.length>1){const e=psqo_factory.decode_psqo(o);e&&(t.form.parse_psqo_to_form(e),t.form_submit(_,{scroll_result:!0}))}else t.load_mint_list().then(function(e){const r=e.result[Math.floor(Math.random()*e.result.length)],n=new form_factory,a=n.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",eq:"=",eq_in:"",eq_out:"",q:`["${r.name}"]`,is_term:!0});t.form_submit(_,{form_items:[a],scroll_result:!0})});return!0},render_form:function(){const e=this,t=new DocumentFragment;e.form=e.form||new form_factory;const r=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:t});e.form.item_factory({id:"global_search",name:"global_search",label:tstring.global_search||"global_search",q_column:"global_search",eq:"MATCH",eq_in:"",eq_out:"",class_name:"global_search",parent:r,callback:function(t){const r=t.node_input,n=common.create_dom_element({element_type:"div",class_name:"search_operators_info",parent:r.parentNode});let a;n.addEventListener("click",function(t){if(t.stopPropagation(),a)return a.remove(),void(a=null);a=e.form.full_text_search_operators_info(),r.parentNode.appendChild(a)}),window.addEventListener("click",function(e){a&&!r.contains(e.target)&&(a.remove(),a=null)})}}),e.form.item_factory({id:"mint",name:"mint",label:tstring.mint||"mint",q_column:"p_mint",value_wrapper:['["','"]'],eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"number",name:"number",q_column:"term",q_table:"types",label:tstring.number_key||"Number & Key",is_term:!1,parent:r,group_op:"$or",callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"culture",name:"culture",label:tstring.culture||"culture",q_column:"p_culture",value_wrapper:['["','"]'],eq_in:"%",eq_out:"%",is_term:!0,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"role",name:"role",label:tstring.role||"Role",q_column:"ref_type_creators_roles",value_split:"|",q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"creator",name:"creator",label:tstring.creator||"creator",q_column:"ref_type_creators_full_name",value_split:" | ",q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"design_obverse",name:"design_obverse",label:tstring.design_obverse||"design obverse",q_column:"ref_type_design_obverse",eq_in:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"design_reverse",name:"design_reverse",label:tstring.design_reverse||"design reverse",q_column:"ref_type_design_reverse",eq_in:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"symbol_obverse",name:"symbol_obverse",label:tstring.symbol_obverse||"symbol obverse",q_column:"ref_type_symbol_obverse",eq_in:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"symbol_reverse",name:"symbol_reverse",label:tstring.symbol_reverse||"symbol reverse",q_column:"ref_type_symbol_reverse",eq_in:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"iconography_obverse",name:"iconography_obverse",label:tstring.iconography_obverse||"iconography obverse",q_column:"ref_type_design_obverse_iconography",value_split:" | ",q_splittable:!0,q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"iconography_reverse",name:"iconography_reverse",label:tstring.iconography_reverse||"iconography reverse",q_column:"ref_type_design_reverse_iconography",value_split:" | ",q_splittable:!0,q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"legend_obverse",name:"legend_obverse",label:tstring.legend_obverse||"legend obverse",q_column:"CONCAT(ref_type_legend_obverse, ' | ', ref_type_legend_transcription_obverse)",q_column_filter:"ref_type_legend_transcription_obverse",eq_in:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"legend_reverse",name:"legend_reverse",label:tstring.legend_reverse||"legend reverse",q_column:"CONCAT(ref_type_legend_reverse, ' | ', ref_type_legend_transcription_reverse)",q_column_filter:"ref_type_legend_transcription_reverse",eq_in:"%",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"territory",name:"territory",label:tstring.territory||"territory",q_column:"p_territory",q_selected_eq:"LIKE",eq_in:"%",eq_out:"%",is_term:!0,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"group",name:"group",label:tstring.group||"group",q_column:"p_group",eq_in:"%",is_term:!0,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"material",name:"material",q_column:"ref_type_material",q_table:"any",label:tstring.material||"material",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"denomination",name:"denomination",q_column:"ref_type_denomination",q_table:"any",label:tstring.denomination||"denomination",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"technique",name:"technique",q_column:"ref_type_technique",q_table:"types",label:tstring.technique||"technique",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"equivalents",name:"equivalents",q_column:"ref_type_equivalents",q_table:"types",eq_in:"%",eq_out:"%",label:tstring.equivalents||"equivalents",is_term:!1,parent:r,callback:function(t){e.form.activate_autocomplete({form_item:t,table:"catalog"})}}),e.form.item_factory({id:"range_slider",name:"range_slider",input_type:"range_slider",label:tstring.period||"Period",class_name:"range_slider",q_column:"ref_date_in,ref_date_end",sql_filter:null,parent:r,callback:function(t){function r(){e.get_catalog_range_years().then(function(e){$(n).slider("instance")&&$(n).slider("destroy"),t.sql_filter=null,a.value=e.min,a.addEventListener("change",function(t){const r=t.target.value>=e.min?t.target.value:e.min;$(n).slider("values",0,r),t.target.value=r}),o.value=e.max,o.addEventListener("change",function(t){const r=t.target.value<=e.max?t.target.value:e.max;$(n).slider("values",1,t.target.value),t.target.value=r}),$(n).slider({range:!0,min:e.min,max:e.max,step:1,values:[e.min,e.max],slide:function(e,t){a.value=t.values[0],o.value=t.values[1]},change:function(e,r){t.sql_filter="(ref_date_in >= "+r.values[0]+" AND ref_date_in <= "+r.values[1]+")",t.q=r.value}})})}const n=t.node_input,a=n.parentNode.querySelector("#range_slider_in"),o=n.parentNode.querySelector("#range_slider_out");r()}}),e.form.item_factory({id:"ref_type_design_obverse_iconography_data",name:"ref_type_design_obverse_iconography_data",class_name:"hide",label:tstring.ref_type_design_obverse_iconography_data||"Design obverse iconography ID",q_column:"ref_type_design_obverse_iconography_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:r,callback:function(e){function t(){e.q&&e.q.length>0?(e.node_input.parentNode.classList.remove("hide"),e.node_input.parentNode.querySelector("input").classList.remove("hide")):e.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",t)}}),e.form.item_factory({id:"ref_type_design_reverse_iconography_data",name:"ref_type_design_reverse_iconography_data",class_name:"hide",label:tstring.ref_type_design_reverse_iconography_data||"Design reverse iconography ID",q_column:"ref_type_design_reverse_iconography_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:r,callback:function(e){function t(){e.q&&e.q.length>0?(e.node_input.parentNode.classList.remove("hide"),e.node_input.parentNode.querySelector("input").classList.remove("hide")):e.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",t)}}),e.form.item_factory({id:"ref_type_symbol_obverse_data",name:"ref_type_symbol_obverse_data",class_name:"hide",label:tstring.ref_type_symbol_obverse_data||"Symbol obverse ID",q_column:"ref_type_symbol_obverse_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:r,callback:function(e){function t(){e.q&&e.q.length>0?(e.node_input.parentNode.classList.remove("hide"),e.node_input.parentNode.querySelector("input").classList.remove("hide")):e.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",t)}}),e.form.item_factory({id:"ref_type_symbol_reverse_data",name:"ref_type_symbol_reverse_data",class_name:"hide",label:tstring.ref_type_symbol_reverse_data||"Symbol reverse ID",q_column:"ref_type_symbol_reverse_data",q_selected_eq:"LIKE",eq_in:'%"',eq_out:'"%',is_term:!1,parent:r,callback:function(e){function t(){e.q&&e.q.length>0?(e.node_input.parentNode.classList.remove("hide"),e.node_input.parentNode.querySelector("input").classList.remove("hide")):e.node_input.parentNode.classList.add("hide")}event_manager.subscribe("form_submit",t)}});const n=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:t}),a=common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:n});a.addEventListener("click",function(t){t.preventDefault(),e.form_submit(i)});const o=common.create_dom_element({element_type:"input",type:"button",id:"button_reset",value:tstring.reset||"Reset",class_name:"btn btn-light btn-block secondary button_reset",parent:n});o.addEventListener("click",function(e){e.preventDefault(),window.location.replace(window.location.pathname)});const _=e.form.build_operators_node();t.appendChild(_);const i=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline"});return i.appendChild(t),i},load_mint_list:function(){const e=data_manager.request({body:{dedalo_get:"records",table:"catalog",ar_fields:["section_id","term AS name","parents"],lang:page_globals.WEB_CURRENT_LANG_CODE,limit:0,count:!1,order:"term ASC",sql_filter:"term_table='mints'"}});return e},form_submit:function(e,t={}){const r=this,n="boolean"!=typeof t.scroll_result||t.scroll_result,a=t.form_items||r.form.form_items,o=r.rows_list_container,_=o.parentNode,i=common.create_dom_element({element_type:"div",class_name:"spinner",parent:_});o.classList.add("loading");const l=r.form.build_filter({form_items:a});if(!l||l.length<1)return i.remove(),o.classList.remove("loading"),!1;if(!r.export_data_buttons){r.export_data_buttons=page.render_export_data_buttons(),r.export_data_container.appendChild(r.export_data_buttons),r.export_data_container.classList.add("hide");const e=page.create_suggestions_button();r.export_data_container.appendChild(e)}_&&!0===n&&_.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"});const s=r.search_rows({filter:l,limit:0,process_result:{fn:"process_result::add_parents_and_children_recursive",columns:[{name:"parents"}]}}).then(e=>{for(event_manager.publish("form_submit",e);o.hasChildNodes();)o.removeChild(o.lastChild);o.classList.remove("loading"),i.remove(),r.draw_rows({target:r.rows_list_container,ar_rows:e}).then(function(){r.export_data_container.classList.remove("hide")})});return s},search_rows:function(e){const t=this,r=e.filter||null,n=e.ar_fields||["*"],a=e.order||"norder ASC",o=page_globals.WEB_CURRENT_LANG_CODE,_=e.process_result||null,i=null!=e.limit?e.limit:30;return new Promise(function(e){const l=[],s=t.form.parse_sql_filter(r);SHOW_DEBUG;const c={dedalo_get:"records",table:"catalog",ar_fields:n,lang:o,sql_filter:s,limit:i,group:l.length>0?l.join(","):null,count:!1,order:a,process_result:_};data_manager.request({body:c}).then(t=>{const n=page.parse_catalog_data(t.result);event_manager.publish("data_request_done",{request_body:c,result:n,export_data_parser:page.export_parse_catalog_data,filter:r}),e(n)})})},draw_rows:function(e){const t=this,r=e.target,n=e.ar_rows||[];return new Promise(function(e){const a=r,o=n.length;if(o<1){for(;a.hasChildNodes();)a.removeChild(a.lastChild);return common.create_dom_element({element_type:"div",class_name:"no_results_found",inner_html:tstring.no_results_found||"No results found",parent:a}),window.scrollTo(0,0),e(a),!1}const _=async function(){const e=new DocumentFragment,r=n.filter(e=>"mints"===e.term_table),a=[];for(let e=0;e<r.length;e++){const t=r[e].parent&&void 0!==r[e].parent[0]?r[e].parent[0]:null,o=t?n.find(e=>e.section_id==t):null;if(!o){console.warn("mint don't have public parent:",r[e]);continue}const _=a.find(e=>e.section_id==t);void 0===_&&a.push(o)}t.parents=a;for(let r=0;r<a.length;r++)t.get_children(n,a[r],e);return e};return _().then(t=>{for(;a.hasChildNodes();)a.removeChild(a.lastChild);a.appendChild(t),setTimeout(function(){const e=a;page.activate_images_gallery(e,!0)},600),e(a)}),!0})},get_children:function(e,t,r){const n=this,a=t.children,o=common.create_dom_element({element_type:"div",class_name:"children_contanier"});if(r.appendChild(o),a)for(let t=0;t<a.length;t++){const r=n.parents.find(e=>e.section_id==a[t]);r||n.get_child(e,a[t],o)}},get_child:function(e,t,r){const n=this,a=e.find(e=>e.section_id==t);if(a){const t=n.render_rows(a,e);r.appendChild(t),a.children&&(n.get_children(e,a,t),t.addEventListener("mouseup",e=>{e.preventDefault();const r="SPAN"===e.target.tagName?e.target.parentNode:e.target;if(r===t.firstChild){const e=t.querySelector(".children_contanier");e.classList.toggle("hide")}},!1))}},render_rows:function(e,t){SHOW_DEBUG,catalog_row_fields.ar_rows=t;const r=catalog_row_fields.draw_item(e);return r},get_catalog_range_years:function(){return new Promise(function(e){const t=["id","section_id","MIN(ref_date_in + 0) AS min","MAX(ref_date_in + 0) AS max"],r={dedalo_get:"records",db_name:page_globals.WEB_DB,lang:page_globals.WEB_CURRENT_LANG_CODE,table:"catalog",ar_fields:t,limit:0,count:!1,offset:0,order:"id ASC"};data_manager.request({body:r}).then(function(t){let r=0,n=0;if(t.result)for(let e=0;e<t.result.length;e++){const a=t.result[e],o=parseInt(a.min);(0===r||o<r)&&(r=o);const _=parseInt(a.max);n=_}const a={min:r,max:n};e(a)})})}};