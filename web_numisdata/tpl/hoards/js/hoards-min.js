"use strict";var hoards={form:null,pagination:null,list:null,form_node:null,form_container:null,rows_container:null,table:null,set_up:function(e){const t=this;t.form_container=e.form_container,t.rows_container=e.rows_container,t.table=e.table,t.form=new form_factory;const n=t.render_form();return t.form_container.appendChild(n),t.pagination={total:null,limit:15,offset:0,n_nodes:8},event_manager.subscribe("paginate",(function(e){t.pagination.offset=e,t.form_submit()})),t.form_submit(),!0},render_form:function(){const e=this,t=new DocumentFragment,n=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:t});e.form.item_factory({id:"global_search",name:"global_search",label:tstring.global_search||"global_search",q_column:"name",eq:"MATCH",eq_in:"",eq_out:"",class_name:"global_search",parent:n,callback:function(t){const n=t.node_input;let o;common.create_dom_element({element_type:"div",class_name:"search_operators_info",parent:n.parentNode}).addEventListener("click",(function(t){if(t.stopPropagation(),o)return o.remove(),void(o=null);o=e.form.full_text_search_operators_info(),n.parentNode.appendChild(o)})),window.addEventListener("click",(function(e){o&&!n.contains(e.target)&&(o.remove(),o=null)}))}}),e.form.item_factory({id:"name",name:"name",label:tstring.name||"Name",q_column:"name",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){const n="findspots"===e.table?"findspots":"hoards";e.form.activate_autocomplete({form_item:t,table:n})}}),e.form.item_factory({id:"place",name:"place",label:tstring.place||"Place",q_column:"place",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){const n="findspots"===e.table?"findspots":"hoards";e.form.activate_autocomplete({form_item:t,table:n})}}),e.form.item_factory({id:"typology",name:"typology",label:tstring.typology||"Typology",q_column:"typology",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){const n=(e.table,"publications");e.form.activate_autocomplete({form_item:t,table:n})}}),e.form.item_factory({id:"indexation",name:"indexation",label:tstring.indexation||"Indexation",q_column:"indexation",eq:"LIKE",eq_in:"%",eq_out:"%",parent:n,callback:function(t){const n="findspots"===e.table?"findspots":"hoards";e.form.activate_autocomplete({form_item:t,table:n})}});const o=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:t});common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:o}).addEventListener("click",(function(t){t.preventDefault(),e.pagination={total:null,limit:15,offset:0,n_nodes:8},e.form_submit()}));const a=e.form.build_operators_node();return t.appendChild(a),e.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline form_factory"}),e.form.node.appendChild(t),e.form.node},form_submit:function(){const e=this;if(!e.form.node)return new Promise((function(e){e(!1)}));const t=e.rows_container;return e.pagination.total?t.classList.add("loading"):page.add_spinner(t),new Promise((function(n){const o="findspots"===e.table?"findspots":"hoards",a=e.form.build_filter(),r=e.form.parse_sql_filter(a,[]),i="(name != '' AND map != '')";let l=i;const s=r?"("+r+")":null;SHOW_DEBUG,s&&(l=i+" AND "+s),data_manager.request({body:{dedalo_get:"records",table:o,ar_fields:["*"],sql_filter:l,limit:0,count:!0,offset:0,order:"name",process_result:null,resolve_portals_custom:{bibliography_data:"bibliographic_references"}}}).then((async function(o){const a=page.parse_hoard_data(o.result),r=o.total;Math.floor(Math.random()*r);a||(t.classList.remove("loading"),n(null)),function(){for(;t.hasChildNodes();)t.removeChild(t.lastChild);t.classList.remove("loading")}();const i=common.create_dom_element({element_type:"div",class_name:"grid-stack",parent:t}),l=GridStack.init(i);l.addWidget({w:4,h:1,content:`${o.result[200].name}`}).querySelector(".grid-stack-item-content").id="titulo-ficha";l.addWidget({w:4,h:2,content:`<img src="https://wondercoins.uca.es${o.result[200].identify_image}" alt="Imagen dinÃ¡mica" style="width:100%; height:100%; object-fit:cover; overflow: hidden;"`}).querySelector(".grid-stack-item-content").id="img_ident";const s=new map_factory;l.addWidget({w:4,h:12,content:""}),l.addWidget({w:4,h:4,content:`${o.result[200].public_info}`});const c=l.addWidget({w:4,h:4,content:""});let d={hallazgos:{datos:[]},cecas:{datos:[]},complejo:{datos:[]}};d.hallazgos.datos.push(o.result[200]),s.init({map_container:c,map_position:o.result[200].map,source_maps:page.maps_config.source_maps,result:d,findspot:!0});const m=await e.render_rows_hallazgo(o.result[200]);l.addWidget({w:2,h:1,content:""}),l.addWidget({w:2,h:1,content:""}),l.addWidget({w:2,h:1,content:""}),l.addWidget({w:2,h:1,content:""}),l.addWidget({w:4,h:1,content:""}),l.addWidget({w:8,h:4,content:`${o.result[200].public_info}`});const _=l.addWidget({w:8,h:5,content:""}).querySelector(".grid-stack-item-content");_.id="arbol_no_moneda",_.appendChild(m),l.addWidget({w:4,h:4,content:""})}));const c=document.querySelector(".rows_container");c&&c.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}))},render_rows_hallazgo:async function(e){const t=new DocumentFragment,n=await this.createfindspot_Tree(e);return this.generate_Tree(n,n[0],t,0),t},createfindspot_Tree:async function(e){const t=[],n=await this.cargarHijosHallazgos(e.section_id);t.push({info_nodo:e,padre:null});for(let e=0;e<n.result.length;e++){const o=JSON.parse(n.result[e].parents);t.push({info_nodo:n.result[e],padre:o[0]})}return t},cargarHijosHallazgos:async function(e){try{return await data_manager.request({body:{dedalo_get:"records",table:"findspots",ar_fields:["*"],sql_filter:`parents LIKE '%"${e}"%'`,limit:0,count:!0,offset:0,order:"section_id ASC",process_result:null}})}catch(e){}},generate_Tree:function(e,t,n,o){const a=common.create_dom_element({element_type:"div",class_name:"container_prueba",text_content:t.info_nodo.name,parent:n});if(a.style.paddingLeft=`${o}em`,null!=t.info_nodo.children)for(let n=0;n<e.length;n++)e[n].info_nodo.parent=='["'+t.info_nodo.section_id+'"]'&&(e[n].padre="'"+t.info_nodo.section_id+"'",this.generate_Tree(e,e[n],a,1.5))}};