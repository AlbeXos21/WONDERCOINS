"use strict";var hoards={form:null,pagination:null,list:null,form_node:null,form_container:null,rows_container:null,table:null,set_up:function(options){const self=this;self.form_container=options.form_container,self.rows_container=options.rows_container,self.table=options.table,self.form=new form_factory;const form_node=self.render_form();function paginate(offset){self.pagination.offset=offset,self.form_submit()}return self.form_container.appendChild(form_node),self.pagination={total:null,limit:15,offset:0,n_nodes:8},event_manager.subscribe("paginate",paginate),self.form_submit(),!0},render_form:function(){const self=this,fragment=new DocumentFragment,form_row=common.create_dom_element({element_type:"div",class_name:"form-row fields",parent:fragment});self.form.item_factory({id:"global_search",name:"global_search",label:tstring.global_search||"global_search",q_column:"name",eq:"MATCH",eq_in:"",eq_out:"",class_name:"global_search",parent:form_row,callback:function(form_item){const node_input=form_item.node_input,button_info=common.create_dom_element({element_type:"div",class_name:"search_operators_info",parent:node_input.parentNode});let operators_info;button_info.addEventListener("click",(function(event){if(event.stopPropagation(),operators_info)return operators_info.remove(),void(operators_info=null);operators_info=self.form.full_text_search_operators_info(),node_input.parentNode.appendChild(operators_info)})),window.addEventListener("click",(function(e){operators_info&&!node_input.contains(e.target)&&(operators_info.remove(),operators_info=null)}))}}),self.form.item_factory({id:"name",name:"name",label:tstring.name||"Name",q_column:"name",eq:"LIKE",eq_in:"%",eq_out:"%",parent:form_row,callback:function(form_item){const table="findspots"===self.table?"findspots":"hoards";self.form.activate_autocomplete({form_item:form_item,table:table})}}),self.form.item_factory({id:"place",name:"place",label:tstring.place||"Place",q_column:"place",eq:"LIKE",eq_in:"%",eq_out:"%",parent:form_row,callback:function(form_item){const table="findspots"===self.table?"findspots":"hoards";self.form.activate_autocomplete({form_item:form_item,table:table})}}),self.form.item_factory({id:"typology",name:"typology",label:tstring.typology||"Typology",q_column:"typology",eq:"LIKE",eq_in:"%",eq_out:"%",parent:form_row,callback:function(form_item){const table=(self.table,"publications");self.form.activate_autocomplete({form_item:form_item,table:table})}}),self.form.item_factory({id:"indexation",name:"indexation",label:tstring.indexation||"Indexation",q_column:"indexation",eq:"LIKE",eq_in:"%",eq_out:"%",parent:form_row,callback:function(form_item){const table="findspots"===self.table?"findspots":"hoards";self.form.activate_autocomplete({form_item:form_item,table:table})}});const submit_group=common.create_dom_element({element_type:"div",class_name:"form-group field button_submit",parent:fragment}),submit_button=common.create_dom_element({element_type:"input",type:"submit",id:"submit",value:tstring.search||"Search",class_name:"btn btn-light btn-block primary",parent:submit_group});submit_button.addEventListener("click",(function(e){e.preventDefault(),self.pagination={total:null,limit:15,offset:0,n_nodes:8},self.form_submit()}));const operators_node=self.form.build_operators_node();return fragment.appendChild(operators_node),self.form.node=common.create_dom_element({element_type:"form",id:"search_form",class_name:"form-inline form_factory"}),self.form.node.appendChild(fragment),self.form.node},form_submit:function(){const self=this,form_node=self.form.node;if(!form_node)return new Promise((function(resolve){console.error("Error on submit. Invalid form_node.",form_node),resolve(!1)}));const rows_container=self.rows_container;return self.pagination.total?rows_container.classList.add("loading"):page.add_spinner(rows_container),new Promise((function(resolve){const table="findspots"===self.table?"findspots":"hoards",ar_fields=["*"],count=!0,order="name",resolve_portals_custom={bibliography_data:"bibliographic_references"},filter=self.form.build_filter(),group=[],parsed_filter=self.form.parse_sql_filter(filter,group),base_filter="(name != '' AND map != '')";let final_filter=base_filter;const sql_filter=parsed_filter?"("+parsed_filter+")":null;!0===SHOW_DEBUG&&console.log("-> coins form_submit sql_filter:",sql_filter),sql_filter&&(final_filter=base_filter+" AND "+sql_filter),console.log(sql_filter),data_manager.request({body:{dedalo_get:"records",table:table,ar_fields:ar_fields,sql_filter:final_filter,limit:0,count:!0,offset:0,order:order,process_result:null,resolve_portals_custom:resolve_portals_custom}}).then((async function(api_response){console.log("--------------- api_response:",api_response);const data=page.parse_hoard_data(api_response.result),total=api_response.total,random=Math.floor(Math.random()*total);data||(rows_container.classList.remove("loading"),resolve(null)),function(){for(;rows_container.hasChildNodes();)rows_container.removeChild(rows_container.lastChild);rows_container.classList.remove("loading")}();const estructura=common.create_dom_element({element_type:"div",class_name:"grid-stack",parent:rows_container}),grid=GridStack.init(estructura),titulo=grid.addWidget({w:4,h:1,content:`${api_response.result[40].name}`}),contentDiv=titulo.querySelector(".grid-stack-item-content");contentDiv.id="titulo-ficha";const imagen_ident=grid.addWidget({w:4,h:2,content:`<img src="https://wondercoins.uca.es${api_response.result[40].identify_image}" alt="Imagen dinámica" style="width:100%; height:100%; object-fit:cover; overflow: hidden;"`}),img_ident=imagen_ident.querySelector(".grid-stack-item-content");img_ident.id="img_ident";const map_fact=new map_factory;grid.addWidget({w:4,h:12,content:""}),grid.addWidget({w:4,h:4,content:`${api_response.result[40].public_info}`});const ubicacion=grid.addWidget({w:4,h:4,content:""});let resultado={hallazgos:{datos:[]},cecas:{datos:[]},complejo:{datos:[]}};resultado.hallazgos.datos.push(api_response.result[40]),map_fact.init({map_container:ubicacion,map_position:api_response.result[40].map,source_maps:page.maps_config.source_maps,result:resultado,findspot:!0});const arbol_no_coins=await self.render_rows_hallazgo(api_response.result[40]);grid.addWidget({w:2,h:1,content:""}),grid.addWidget({w:2,h:1,content:""}),grid.addWidget({w:2,h:1,content:""}),grid.addWidget({w:2,h:1,content:""}),grid.addWidget({w:4,h:1,content:""}),grid.addWidget({w:8,h:4,content:`${api_response.result[40].public_info}`});const nodo_arbol_no_coins=grid.addWidget({w:8,h:5,content:""}),hijo_nodo_arbol_no_coins=nodo_arbol_no_coins.querySelector(".grid-stack-item-content");hijo_nodo_arbol_no_coins.id="arbol_no_moneda",hijo_nodo_arbol_no_coins.appendChild(arbol_no_coins),grid.addWidget({w:4,h:4,content:""});const titulo_arbol=common.create_dom_element({element_type:"h1",class_name:"title",text_content:"Árbol del Hallazgo",parent:rows_container});common.create_dom_element({element_type:"div",class_name:"golden-separator",parent:titulo_arbol});const arbol_completo=common.create_dom_element({element_type:"div",class_name:"arbol_moneda",parent:rows_container});arbol_completo.appendChild(await self.render_rows_hallazgo_completo(api_response.result[40]))}));const div_result=document.querySelector(".rows_container");div_result&&div_result.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}))},render_rows_hallazgo:async function(row){const fragment=new DocumentFragment;var findspot_tree=await this.createfindspot_Tree(row);return this.generate_Tree(findspot_tree,findspot_tree[0],fragment,0),fragment},render_rows_hallazgo_completo:async function(row){const fragment=new DocumentFragment;var findspot_tree=await this.createfindspot_Tree(row);return this.generate_Tree_completo(findspot_tree,findspot_tree[0],fragment,0),fragment},createfindspot_Tree:async function(findspot){const findspots_tree=[],findspot_sons=await this.cargarHijosHallazgos(findspot.section_id);findspots_tree.push({info_nodo:findspot,padre:null});for(let index=0;index<findspot_sons.result.length;index++){const parent_node=JSON.parse(findspot_sons.result[index].parents);findspots_tree.push({info_nodo:findspot_sons.result[index],padre:parent_node[0]})}return findspots_tree},cargarHijosHallazgos:async function(hallazgo){try{const hijos=await data_manager.request({body:{dedalo_get:"records",table:"findspots",ar_fields:["*"],sql_filter:`parents LIKE '%"${hallazgo}"%'`,limit:0,count:!0,offset:0,order:"section_id ASC",process_result:null}});return hijos}catch(error){console.error("Error cargando datos:",error)}},generate_Tree:function(tree,node,node_parent,padding){const info_node=common.create_dom_element({element_type:"div",class_name:"container_prueba",text_content:node.info_nodo.name,parent:node_parent});if(info_node.style.paddingLeft=`${padding}em`,null!=node.info_nodo.children)for(let index=0;index<tree.length;index++)tree[index].info_nodo.parent=='["'+node.info_nodo.section_id+'"]'&&(tree[index].padre="'"+node.info_nodo.section_id+"'",this.generate_Tree(tree,tree[index],info_node,1.5))},cargarMonedasHallazgos:async function(ceca){try{const monedas=await data_manager.request({body:{dedalo_get:"records",table:"coins",ar_fields:["*"],sql_filter:`findspot LIKE '%${ceca}%'`,limit:15,count:!0,offset:0,order:"section_id ASC",process_result:null}});return monedas}catch(error){console.error("Error cargando datos:",error)}},generate_Tree_completo:async function(tree,node,node_parent,padding){const info_node=common.create_dom_element({element_type:"div",class_name:"container_prueba",text_content:node.info_nodo.name,parent:node_parent});if(info_node.style.paddingLeft=`${padding}em`,console.log(node),null!=node.info_nodo.coins){const coins=await this.cargarMonedasHallazgos(node.info_nodo.name),container_swiper=common.create_dom_element({element_type:"div",class_name:`swiper swiper_${node.info_nodo.section_id}`,parent:info_node}),swiper=common.create_dom_element({element_type:"div",class_name:"swiper-wrapper",parent:container_swiper}),slide1=common.create_dom_element({element_type:"div",class_name:"swiper-slide",parent:swiper}),flipCard1=common.create_dom_element({element_type:"div",class_name:"flip-card",parent:slide1}),flipInner1=common.create_dom_element({element_type:"div",class_name:"flip-card-inner",parent:flipCard1}),flipFront1=common.create_dom_element({element_type:"div",class_name:"flip-card-front",parent:flipInner1});common.create_dom_element({element_type:"img",parent:flipFront1,src:"https://placehold.co/400"}),common.create_dom_element({element_type:"img",parent:flipFront1,src:"https://placehold.co/400"});const flipBack1=common.create_dom_element({element_type:"div",class_name:"flip-card-back",parent:flipInner1});common.create_dom_element({element_type:"h3",text_content:"Moneda Romana",parent:flipBack1}),common.create_dom_element({element_type:"p",text_content:"Año: 1800",parent:flipBack1}),common.create_dom_element({element_type:"p",text_content:"Metal: Oro",parent:flipBack1}),common.create_dom_element({element_type:"p",text_content:"País: Roma",parent:flipBack1}),common.create_dom_element({element_type:"div",class_name:"swiper-slide",text_content:"Slide - 2",parent:swiper}),common.create_dom_element({element_type:"div",class_name:`swiper-button-prev swiper-prev-${node.info_nodo.section_id}`,parent:container_swiper}),common.create_dom_element({element_type:"div",class_name:`swiper-button-next swiper-next-${node.info_nodo.section_id}`,parent:container_swiper}),common.create_dom_element({element_type:"div",class_name:`swiper-pagination swiper-pagination-${node.info_nodo.section_id}`,parent:container_swiper}),container_swiper.style.paddingLeft="1em",new Swiper(`.swiper_${node.info_nodo.section_id}`,{loop:!0,pagination:{el:`.swiper-pagination-${node.info_nodo.section_id}`,clickable:!0},navigation:{nextEl:`.swiper-next-${node.info_nodo.section_id}`,prevEl:`.swiper-prev-${node.info_nodo.section_id}`}}),document.addEventListener("click",e=>{const card=e.target.closest(".flip-card");card&&card.classList.toggle("flipped")})}if(null!=node.info_nodo.children)for(let index=0;index<tree.length;index++)tree[index].info_nodo.parent=='["'+node.info_nodo.section_id+'"]'&&(tree[index].padre="'"+node.info_nodo.section_id+"'",this.generate_Tree_completo(tree,tree[index],info_node,1.5))},generate_rows_findspot:function(parent,coins){for(let index=0;index<coins.length;index++){const info_coin=common.create_dom_element({element_type:"div",class_name:"info_coin",parent:parent}),container_images=common.create_dom_element({element_type:"div",class_name:"container_images",parent:info_coin}),parsedCoinData=coins[index],image_obverse="https://wondercoins.uca.es"+parsedCoinData.image_obverse;common.create_dom_element({element_type:"img",class_name:"img_observe",src:image_obverse,parent:container_images});const image_reverse="https://wondercoins.uca.es"+parsedCoinData.image_reverse;common.create_dom_element({element_type:"img",class_name:"img_reserve",src:image_reverse,parent:container_images});const container_data=common.create_dom_element({element_type:"div",class_name:"container_data",parent:info_coin});let weight_text=null;weight_text=null!=coins[index].weight?"Peso: "+coins[index].weight+"g":"Peso: N/A";const weight=common.create_dom_element({element_type:"span",class_name:"weight",text_content:weight_text,parent:container_data}),diameter=common.create_dom_element({element_type:"span",class_name:"diameter",text_content:"Módulo: "+coins[index].diameter+"mm",parent:container_data}),catalogue_type=common.create_dom_element({element_type:"span",class_name:"catalogue_type",text_content:"Colección: "+coins[index].collection,parent:container_data});let findspot_text=coins[index].findspot.split(" | ")[0];const findspot=common.create_dom_element({element_type:"span",class_name:"findspot",text_content:"Hallazgo: "+findspot_text,parent:info_coin}),tipo=common.create_dom_element({element_type:"span",class_name:"type",text_content:"Tipo: "+coins[index].type_full_value,parent:info_coin}),container_links=common.create_dom_element({element_type:"div",class_name:"container_links",parent:info_coin}),type_link=common.create_dom_element({element_type:"a",class_name:"type_link",href:"/web_numisdata/type/"+coins[index].type,text_content:"TIPO",parent:container_links})}}};